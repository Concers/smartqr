generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(cuid())
  email                String         @unique
  password             String
  name                 String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  approvedCustomDomain String?        @unique
  customDomainEnabled  Boolean        @default(false)
  subdomain            String?        @unique
  subdomainHistory     Json           @default("[]")
  customDomains        CustomDomain[]
  subdomainRequests    SubdomainRequest[]
  qrCodes              QrCode[]
  subUsers             SubUser[]      // Parent relationship: User -> SubUser

  @@map("users")
}

model SubdomainRequest {
  id                 String   @id @default(cuid())
  userId             String
  requestedSubdomain String
  status             String   @default("pending") // pending, approved, rejected
  adminNotes         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  approvedAt         DateTime?
  rejectedAt         DateTime?

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([requestedSubdomain])
  @@index([userId])
  @@index([status])
  @@map("subdomain_requests")
}

model SubUser {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String?
  isActive    Boolean  @default(true)
  permissions Json     @default("{}") // { qr_create: true, qr_edit: false, qr_delete: false, analytics_view: true }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relationships
  parentUserId String
  parentUser   User     @relation(fields: [parentUserId], references: [id], onDelete: Cascade)
  
  // Audit fields
  createdBy   String?
  updatedBy   String?

  @@unique([parentUserId, email]) // Email must be unique within parent's scope
  @@index([parentUserId])
  @@index([isActive])
  @@map("sub_users")
}

model QrCode {
  id                  String           @id @default(cuid())
  shortCode           String           @unique
  originalUrl         String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  isActive            Boolean          @default(true)
  userId              String?
  qrImageUrl          String?
  customDomainEnabled Boolean          @default(false)
  customUrl           String?
  lockedSubdomain     String?          // Locks this QR to a specific subdomain permanently
  analytics           QrAnalytics[]
  user                User?            @relation(fields: [userId], references: [id])
  destinations        UrlDestination[]

  @@map("qr_codes")
}

model UrlDestination {
  id             String    @id @default(cuid())
  qrCodeId       String
  destinationUrl String
  activeFrom     DateTime  @default(now())
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  priority       Int       @default(1)
  qrCode         QrCode    @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@map("url_destinations")
}

model QrAnalytics {
  id         String   @id @default(cuid())
  qrCodeId   String
  ipAddress  String?
  userAgent  String?
  country    String?
  city       String?
  deviceType String?
  browser    String?
  accessedAt DateTime @default(now())
  qrCode     QrCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@map("qr_analytics")
}

model CustomDomain {
  id                String    @id @default(cuid())
  userId            String
  domain            String    @unique
  status            String    @default("pending")
  dnsVerified       Boolean   @default(false)
  sslConfigured     Boolean   @default(false)
  verificationToken String    @unique
  adminNotes        String?
  requestedAt       DateTime  @default(now())
  approvedAt        DateTime?
  rejectedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("custom_domains")
}
